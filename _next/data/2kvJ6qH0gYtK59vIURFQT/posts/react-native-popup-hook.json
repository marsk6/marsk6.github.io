{"pageProps":{"post":{"__typename":"Post","slug":"react-native-popup-hook","title":"react native å¼¹çª—æµ®å±‚çš„ç®¡ç†æ–¹å¼","tags":[{"__typename":"Tag","name":"react"}],"category":null,"ctime":1683803880000,"mtime":1683879240000,"date":"05-11","content":"\n## èƒŒæ™¯\n\nåœ¨ react native éœ€æ±‚å¼€å‘ä¸­ï¼Œç»å¸¸é‡åˆ°æµ®å±‚çš„éœ€æ±‚ï¼Œå³ `Dialog`ï¼Œ`BottomDrawer`ï¼Œ`Modal` ç­‰æµ®å±‚ç»„ä»¶ï¼Œä½†å†…éƒ¨çš„å…¬å…±ç»„ä»¶åº“æ€»æ˜¯éš¾ä»¥æ»¡è¶³éœ€æ±‚ï¼Œä¾‹å¦‚æµ®å±‚å±‚å ï¼Œæ“ä½œæµ®å±‚çš„æ–¹å¼ï¼Œè·å–æ“ä½œçš„ç»“æœç­‰ï¼Œéœ€è¦äºŒæ¬¡å¼€å‘ã€‚\n\n### ç°æœ‰æµ®å±‚å®ç°ç›¸ä¼¼ç‚¹\n\nç ”ç©¶ä¸‹äº†å†…éƒ¨ç»„ä»¶åº“çš„å®ç°ï¼Œå®ç°ä¸Šæœ‰ç›¸åŒï¼Œéƒ½æœ‰ç›¸ä¼¼çš„å±•ç¤ºæµ®å±‚ï¼Œå…³é—­æµ®å±‚çš„çŠ¶æ€ç®¡ç†é€»è¾‘ï¼Œ\n\n```tsx title={Dialog.tsx} *{2,16}\nexport class Dialog extends PureComponent {\n  static showPopup = (config) => { // ğŸ‘ˆğŸ» æ“ä½œæ˜¾ç¤ºæµ®å±‚\n    return new Promise((resolve) => {\n      const inst = Dialog.instances[pageId];\n      if (inst) {\n        inst.setState({\n          show: true,\n          config,\n        });\n      }\n    });\n  };\n\n  handleDismiss = (result) => {\n    // ğŸ‘‡ğŸ» éšè—æµ®å±‚\n    this.setState({ show: false }, () => this.resolve?.({ action: result }));\n  };\n\n  render() {\n    const { show } = this.state;\n    if (!show) {\n      return null;\n    }\n    return (\n      <View>\n        <TouchableOpacity onPress={() => this.handleDismiss(Dialog.Action.Cancel)}>\n          <Text>Cancel</Text>\n        </TouchableOpacity>\n      </View>\n    );\n  }\n}\n```\n\n### ç°æœ‰æµ®å±‚å®ç°ä¸åŒç‚¹\n\nä½¿ç”¨ä¸Šåˆæœ‰äº›ä¸åŒï¼Œ`Dialog` æ¸²æŸ“çš„ä½ç½®ä¼šæ”¾åœ¨é¡¶å±‚ç»„ä»¶æ ‘ï¼Œç„¶ååœ¨å­ç»„ä»¶å†…éƒ¨é€šè¿‡ `Dialog.showPopup(config)` é…ç½®å¹¶æ˜¾ç¤º `Dialog`\n\n```tsx title={Screen.tsx} *{7}\nfunction Screen() {\n  return (\n    <View>\n      <View>\n        <Child />\n      </View>\n      <Dialog /> {/* ğŸ‘ˆğŸ» åœ¨è¿™é‡Œæ¸²æŸ“ Dialog */}\n    </View>\n  );\n}\n```\n\n```tsx title={Child.tsx} *{3}\nfunction Child() {\n  const handlePress = () => {\n    const result = await Dialog.showPopup(config); // ğŸ‘ˆğŸ» é…ç½®å¹¶æ˜¾ç¤º Dialogï¼Œè·å–æ“ä½œ Dialog çš„ç»“æœ\n  };\n  return <View onPress={handlePress}>{/* ... */}</View>;\n}\n```\n\n`BottomDrawer`ï¼Œ`Modal` æ”¾åˆ°ç»„ä»¶æ ‘ï¼Œå½“æ™®é€šç»„ä»¶å¼•ç”¨ï¼Œå…¶å®ä¸ºäº†è¦†ç›–æ•´ä¸ªå±å¹•ï¼Œä¹Ÿå¿…é¡»æ”¾åœ¨é¡µé¢çš„é¡¶å±‚ç»„ä»¶æ ‘ä¸­\n\nè¿™ä¸ªæ–¹å¼æ¯ä¸ªé¡µé¢éƒ½è¦ç»´æŠ¤ä¸€å¥—å±•ç¤ºå’Œéšè—çš„çŠ¶æ€é€»è¾‘\n\n```tsx title={Screen.tsx} *{7-9}\nfunction Screen() {\n  return (\n    <View>\n      <View>\n        <Child />\n      </View>\n      <BottomDrawer show={state.showContent1}>{/* content */}</BottomDrawer>\n      <BottomDrawer show={state.showContent2}>{/* content */}</BottomDrawer>\n      <Modal visible={state.visible}>{/* content */}</Modal>\n    </View>\n  );\n}\n```\n\n### å­˜åœ¨é—®é¢˜\n\nè¿™æ ·ç»´æŠ¤èµ·æ¥æœ‰äº›æ··ä¹±ï¼Œæ¯æ¬¡éœ€æ±‚å¼€å‘éƒ½è¦æŠŠç»„ä»¶äºŒæ¬¡æ”¹é€ ä¸€ä¸‹ï¼Œè¦ä¹ˆé¡µé¢å­˜åœ¨å¤§é‡å±•ç¤ºéšè—çš„çŠ¶æ€é€»è¾‘ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿä¸ä¸€è‡´ï¼Œå¤šæ¬¡è¿­ä»£åå°±å¾—èŠ±æ›´å¤šæ—¶é—´å­¦ä¹ ç ”ç©¶ç»„ä»¶æ€ä¹ˆç”¨ï¼Œè¦ä¹ˆæ–°çš„å¼€å‘è€…åˆé‡æ–°å†™ä¸€å¥—ã€‚\n\nå®é™…æ‰“å¼€æµ®å±‚ï¼Œå±‚å å±•ç¤ºå¤šä¸ªæµ®å±‚ï¼Œå…³é—­æµ®å±‚ï¼Œå®ƒä»¬çš„çŠ¶æ€ç®¡ç†é€»è¾‘åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯åœ¨è¡¨ç°å±‚ä¸ä¸€æ ·ï¼Œå› æ­¤å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª hookï¼Œæå–å®ƒä»¬çš„å…±åŒé€»è¾‘ã€‚\n\n## ä»£ç å®ç°\n\nç”¨æ–¹æ³•çš„å½¢å¼æ“ä½œæµ®å±‚ï¼Œæä¾› `open`ï¼Œ`close`ï¼Œ`closeAll` 3 ä¸ªæ–¹æ³•\n\n```typescript title={usePopupStack.ts}\nimport { ReactNode, useContext, useEffect, useMemo, useRef } from 'react';\nimport { Keyboard, Platform, BackHandler } from 'react-native';\nimport useCallbackState from './useCallbackState';\n\ntype TPopUpInfo = {\n  shouldShow: boolean;\n  component: ReactNode;\n  onClose: () => void;\n};\n\nexport type TManageStack = {\n  open: (renderComponent: (onClose: () => void) => ReactNode) => number;\n  close: (popUpId: number) => void;\n  closeAll: () => void;\n};\n\n/**\n * Dialog, BottomDrawer, Modal etc.\n */\nexport const usePopupStack = () => {\n  const [list, setList] = useCallbackState<TPopUpInfo[]>([]);\n  const popUpMap = useRef<Map<number, TPopUpInfo>>(new Map());\n  const manageStack = useMemo((): TManageStack => {\n    return {\n      open: (renderComponent) => {\n        const popUpId = Date.now();\n        const onClose = () => {\n          // å¿«é€Ÿç‚¹å‡»ä¼šæ‰§è¡Œå¤šæ¬¡\n          if (popUpMap.current.get(popUpId)) {\n            popUpMap.current.get(popUpId)!.shouldShow = false;\n            setList(cloneList(popUpMap.current), () => {\n              popUpMap.current.delete(popUpId);\n            });\n          }\n        };\n        const component = renderComponent(onClose);\n        popUpMap.current.set(popUpId, {\n          shouldShow: true,\n          component,\n          onClose,\n        });\n        Keyboard.dismiss();\n        setList(cloneList(popUpMap.current)); // ğŸ‘ˆğŸ» ä¸èƒ½æ¸²æŸ“ refï¼ŒæŠŠ list clone å­˜åˆ° state ä¸Š\n        return popUpId;\n      },\n      close: (popUpId: number) => {\n        popUpMap.current.get(popUpId)?.onClose();\n      },\n      closeAll: () => {\n        [...popUpMap.current.values()].forEach((popup) => {\n          popup.onClose();\n        });\n      },\n    };\n  }, [setList]);\n\n  useEffect(() => {\n    // ç›‘å¬ android çš„å®ä½“è¿”å›é”®ï¼Œå…³é—­ pop up\n    if (Platform.OS === 'android') {\n      BackHandler.addEventListener('hardwareBackPress', function () {\n        if (popUpMap.current) {\n          const topPopupId = Array.from(popUpMap.current.keys()).pop();\n          if (topPopupId) {\n            manageStack.close(topPopupId);\n          }\n        }\n      });\n    }\n    return () => {\n      if (Platform.OS === 'android') {\n        BackHandler.removeEventListener('hardwareBackPress');\n      }\n    };\n  }, [manageStack]);\n\n  return { manageStack, list };\n};\n```\n\n### ç”¨æ³•\n\næ¯ç§æµ®å±‚éƒ½ç”¨ `usePopupStack` ç®¡ç†ï¼Œç”¨ context å¾€ä¸‹ä¼ é€’ `open`ï¼Œ`close`ï¼Œ`closeAll` 3 ä¸ªæ–¹æ³•\n\n```tsx title={BottomDrawerContextProvider.tsx}\nimport React, { createContext, PropsWithChildren } from 'react';\nimport BottomDrawer from '//ButtomDrawer';\nimport { usePopupStack } from './usePopupStack';\nimport type { TManageStack } from './usePopupStack';\n\nexport const BottomDrawerContext = createContext({} as TManageStack);\n\nexport const BottomDrawerContextProvider: React.FC<PropsWithChildren> = (props) => {\n  const { manageStack: bottomDrawer, list: drawerList } = usePopupStack();\n\n  return (\n    <BottomDrawerContext.Provider value={bottomDrawer}>\n      {props.children}\n      {drawerList.map(\n        // æ¸²æŸ“ open çš„ BottomDrawer\n        ({ component, shouldShow, onClose }, index) => (\n          <BottomDrawer\n            key={index}\n            shouldShow={shouldShow}\n            onDismiss={onClose}\n          >\n            {component}\n          </BottomDrawer>\n        )\n      )}\n    </BottomDrawerContext.Provider>\n  );\n};\n```\n\næµ®å±‚ç»„ä»¶éƒ½æ”¾åˆ°é¡¶å±‚ç»„ä»¶æ ‘æ¸²æŸ“ï¼Œè¿™æ ·æµ®å±‚å¯ä»¥è¦†ç›–æ•´ä¸ªé¡µé¢ã€‚\n\n```tsx title={Screen.tsx}\nfunction Screen() {\n  <BottomDrawerContextProvider>\n    <DialogContextProvider>\n      <View>...</View>\n    </DialogContextProvider>\n  </BottomDrawerContextProvider>;\n}\n```\n\nå­ç»„ä»¶ä» context è·å– `open`ï¼Œ`close`ï¼Œ`closeAll` æ–¹æ³•\n\n```tsx title={Child.tsx}\nfunction Child() {\n  const bottomDrawer = useContext(BottomDrawerContext);\n  const handle = () => {\n    const drawerId = bottomDrawer.open((onClose) => {\n      return (\n        <View>\n          <Button onPress={onClose}>Close</Button>\n        </View>\n      );\n    });\n  };\n\n  useEffect(() => {\n    return () => {\n      bottomDrawer.close(drawerId);\n    };\n  }, []);\n\n  return <></>;\n}\n```\n\nè¿™æ ·ï¼ŒæŠ½å–ä¸€ä¸ª hookï¼Œæ¯ä¸ªç»„ä»¶ä¸ç”¨ç»´æŠ¤æµ®å±‚çš„çŠ¶æ€ï¼Œä½¿ç”¨ä¹Ÿç®€æ´æ¸…æ™°ã€‚\n\n> [æœ¬åšå®¢](https://marsk6.github.io/) æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼\n","prevArticle":{"__typename":"Post","title":"react hooks setState æ”¯æŒ callback","slug":"setState-callback-react-hooks"},"nextArticle":null,"readingTime":"5","brief":"Dialogï¼ŒBottomDrawerï¼ŒModalï¼ŒTooltip ç­‰å„ç§æµ®å±‚å¼¹çª—è™½ç„¶åœ¨è¡¨ç°ä¸Šä¸ä¸€æ ·ï¼Œä½†ä»–ä»¬çš„çŠ¶æ€ç®¡ç†é€»è¾‘ï¼Œå¦‚æ‰“å¼€æµ®å±‚ï¼Œå…³é—­æµ®å±‚ï¼Œå±‚å æµ®å±‚ç­‰é€»è¾‘ç›¸å·®ä¸å¤§ï¼Œå› æ­¤å¯ä»¥å®ç°ä¸€ä¸ª hookï¼ŒæŠ½å–å…±åŒçš„é€»è¾‘ï¼Œå­ç»„ä»¶é—´ç”¨ context å…±äº«å…¬å…±çš„æµ®å±‚æ“ä½œæ–¹æ³•ã€‚","toc":"- [èƒŒæ™¯](#%E8%83%8C%E6%99%AF)\n  * [ç°æœ‰æµ®å±‚å®ç°ç›¸ä¼¼ç‚¹](#%E7%8E%B0%E6%9C%89%E6%B5%AE%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%9B%B8%E4%BC%BC%E7%82%B9)\n  * [ç°æœ‰æµ®å±‚å®ç°ä¸åŒç‚¹](#%E7%8E%B0%E6%9C%89%E6%B5%AE%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%8D%E5%90%8C%E7%82%B9)\n  * [å­˜åœ¨é—®é¢˜](#%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98)\n- [ä»£ç å®ç°](#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0)\n  * [ç”¨æ³•](#%E7%94%A8%E6%B3%95)"},"relatedTags":[{"__typename":"Tag","name":"react","posts":[{"__typename":"Post","slug":"error-boundary-for-custom-error"},{"__typename":"Post","slug":"react-native-popup-hook"}]}]},"__N_SSG":true}